config:
  replica-replace-pattern: '%'
  show-failure-report: yes

  # Show an eta for each task on the screen (being shown on every line 
  # with a command running)
  show-task-times: true

  log-path: build.log
  env:
    __TEST1_GLOBAL: 12345

x-reference-data:
  all-apps: &app-names
    - some-lib-4
    - utilities-lib
    - important-lib
    - some-app1
    - some-app3
    - some-awesome-app-5
    - watcher-app
    - yup-another-app-7

tasks:

  - name: test0 %
    tags: [t,t0]
    cmd: echo %
    ignore-failure: no
    stdout-log: /tmp/test0-%.log
    cmd-log: /tmp/test0-%-cmd.log
    for-each:
      - abc
      - def

  - name: test01
    tags: t01
    ignore-failure: no
    cmd-log: /tmp/test01-cmd.log
    parallel-tasks:
      - name: "Cloning %"
        cmd: echo %
        ignore-failure: no
        stdout-log: /tmp/test01-%-out.log
        stderr-log: /tmp/test01-%-err.log
        cmd-log: /tmp/test01-cmd1.log
        for-each:
          - abc
          - def

  - name: test1
    tags: t
    ignore-failure: no
    parallel-tasks:
      - name: "Cloning %"
        cmd: ls /1||date
        ignore-failure: no
        stdout-log: /tmp/test1-%-out.log
        stderr-log: /tmp/test1-%-err.log
        for-each:
          - abc
          - def

  - name: test1
    tags: t
    cmd: example/dev.sh
    ignore-failure: false
    env:
      __TEST1_AAA: 123
      __TEST1_BBB: 456

  - name: test2
    tags: t
    cmd: example/dev.sh
    ignore-failure: false
    env:
      __TEST1_CCC: xxxxxxxxxxxxxxxxxx

  - name: Cloning Repos
    collapse-on-completion: true
    parallel-tasks:
      - name: "Cloning <replace>"
        cmd: example/scripts/random-worker.sh 1 <replace>
        ignore-failure: true
        for-each: *app-names

  - name: Installing dependencies
    parallel-tasks:
      - name: Installing Oracle client
        cmd: example/scripts/random-worker.sh 3
      - name: Installing Google chrome
        cmd: example/scripts/random-worker.sh 4
      - name: Installing MD helper
        cmd: example/scripts/random-worker.sh 5
      - name: Installing Bridgy
        cmd: example/scripts/random-worker.sh 6

  - name: Building Base Image
    cmd: example/scripts/random-worker.sh 3

#  - name: Building Application Images
#    parallel-tasks:
#    - name: some-app1
#      cmd: example/scripts/random-worker.sh 3
#    - name: some-app3
#      cmd: example/scripts/random-worker.sh 4
#    - name: some-awesome-app-5
#      cmd: example/scripts/random-worker.sh 3
#    - name: watcher-app
#      cmd: example/scripts/random-worker.sh 2
#    - name: yup-another-app-7
#      cmd: example/scripts/random-worker.sh 2

  - name: Gathering Secrets
    cmd: example/scripts/random-worker.sh 3

  - name: Building and Migrating
    parallel-tasks:
      - name: Building app1
        cmd: example/scripts/random-worker.sh 5
      - name: Building some-app3
        cmd: example/scripts/random-worker.sh 5
      - name: Building some-lib-4
        cmd: example/scripts/random-worker.sh 6
      - name: Building some-awesome-app-5
        cmd: example/scripts/random-worker.sh 7
      - name: Building watcher-app
        cmd: example/scripts/random-worker.sh 5
      - name: Building public-6
        cmd: example/scripts/random-worker.sh 5
